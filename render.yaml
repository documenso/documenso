# Deploy Documenso to Render with Render Postgres.
# Production URLs (add as custom domains in Render):
#   - documenso-app: https://sign.pinogy.com
#   - token-exchange: https://sign-token.pinogy.com
databases:
  - name: documenso-db
    plan: free
    region: oregon

services:
  - type: web
    runtime: node
    name: documenso-app
    plan: free
    buildCommand: npm ci && npm run build
    # Run migrations from root, then start server from apps/remix (turbo runs start from root so main.js path would be wrong)
    startCommand: npx prisma migrate deploy --schema packages/prisma/schema.prisma && (cd apps/remix && node build/server/main.js)
    healthCheckPath: /api/health

    envVars:
      - key: NODE_VERSION
        value: "22"

      - key: NEXTAUTH_URL
        fromService:
          name: documenso-app
          type: web
          envVarKey: RENDER_EXTERNAL_URL
      - key: NEXTAUTH_SECRET
        generateValue: true

      # Database: auto-injected from Render Postgres above.
      - key: NEXT_PRIVATE_DATABASE_URL
        fromDatabase:
          name: documenso-db
          property: connectionString
      - key: NEXT_PRIVATE_DIRECT_DATABASE_URL
        fromDatabase:
          name: documenso-db
          property: connectionString

      - key: NEXT_PUBLIC_WEBAPP_URL
        fromService:
          name: documenso-app
          type: web
          envVarKey: RENDER_EXTERNAL_URL
      - key: NEXT_PRIVATE_INTERNAL_WEBAPP_URL
        fromService:
          name: documenso-app
          type: web
          envVarKey: RENDER_EXTERNAL_URL

      # SMTP
      - key: NEXT_PRIVATE_SMTP_TRANSPORT
        value: 'smtp-auth'
      - key: NEXT_PRIVATE_SMTP_HOST
        sync: false
      - key: NEXT_PRIVATE_SMTP_PORT
        sync: false
      - key: NEXT_PRIVATE_SMTP_USERNAME
        sync: false
      - key: NEXT_PRIVATE_SMTP_PASSWORD
        sync: false
      - key: NEXT_PRIVATE_SMTP_FROM_NAME
        sync: false
      - key: NEXT_PRIVATE_SMTP_FROM_ADDRESS
        sync: false

      # Stripe
      - key: NEXT_PRIVATE_STRIPE_API_KEY
        sync: false
      - key: NEXT_PRIVATE_STRIPE_WEBHOOK_SECRET
        sync: false

      # Features
      - key: NEXT_PUBLIC_POSTHOG_KEY
        sync: false
      - key: NEXT_PUBLIC_FEATURE_BILLING_ENABLED
        sync: false

      # Storage
      - key: NEXT_PUBLIC_UPLOAD_TRANSPORT
        value: 'database'
      - key: NEXT_PRIVATE_UPLOAD_ENDPOINT
        sync: false
      - key: NEXT_PRIVATE_UPLOAD_FORCE_PATH_STYLE
        sync: false
      - key: NEXT_PRIVATE_UPLOAD_REGION
        sync: false
      - key: NEXT_PRIVATE_UPLOAD_BUCKET
        sync: false
      - key: NEXT_PRIVATE_UPLOAD_ACCESS_KEY_ID
        sync: false
      - key: NEXT_PRIVATE_UPLOAD_SECRET_ACCESS_KEY
        sync: false

      # Crypto
      - key: NEXT_PRIVATE_ENCRYPTION_KEY
        generateValue: true
      - key: NEXT_PRIVATE_ENCRYPTION_SECONDARY_KEY
        generateValue: true

      # Auth Optional
      - key: NEXT_PRIVATE_GOOGLE_CLIENT_ID
        sync: false
      - key: NEXT_PRIVATE_GOOGLE_CLIENT_SECRET
        sync: false

      # Signing
      - key: NEXT_PRIVATE_SIGNING_TRANSPORT
        sync: false
      - key: NEXT_PRIVATE_SIGNING_PASSPHRASE
        sync: false
      - key: NEXT_PRIVATE_SIGNING_LOCAL_FILE_PATH
        sync: false
      - key: NEXT_PRIVATE_SIGNING_LOCAL_FILE_CONTENTS
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_KEY_PATH
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_PUBLIC_CRT_FILE_PATH
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_PUBLIC_CRT_FILE_CONTENTS
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_APPLICATION_CREDENTIALS_CONTENTS
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_CERT_CHAIN_FILE_PATH
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_CERT_CHAIN_CONTENTS
        sync: false
      - key: NEXT_PRIVATE_SIGNING_GCLOUD_HSM_SECRET_MANAGER_CERT_PATH
        sync: false
      - key: NEXT_PRIVATE_SIGNING_TIMESTAMP_AUTHORITY
        sync: false
      - key: NEXT_PUBLIC_SIGNING_CONTACT_INFO
        sync: false
      - key: NEXT_PRIVATE_USE_LEGACY_SIGNING_SUBFILTER
        sync: false

      # SMTP Optional
      - key: NEXT_PRIVATE_SMTP_APIKEY_USER
        sync: false
      - key: NEXT_PRIVATE_SMTP_APIKEY
        sync: false
      - key: NEXT_PRIVATE_SMTP_SECURE
        sync: false
      - key: NEXT_PRIVATE_RESEND_API_KEY
        sync: false
      - key: NEXT_PRIVATE_MAILCHANNELS_API_KEY
        sync: false
      - key: NEXT_PRIVATE_MAILCHANNELS_ENDPOINT
        sync: false
      - key: NEXT_PRIVATE_MAILCHANNELS_DKIM_DOMAIN
        sync: false
      - key: NEXT_PRIVATE_MAILCHANNELS_DKIM_SELECTOR
        sync: false
      - key: NEXT_PRIVATE_MAILCHANNELS_DKIM_PRIVATE_KEY
        sync: false
      - key: NEXT_PUBLIC_DOCUMENT_SIZE_UPLOAD_LIMIT
        sync: false

      # Features Optional
      - key: NEXT_PUBLIC_DISABLE_SIGNUP
        sync: false
      - key: NEXT_PUBLIC_USE_INTERNAL_URL_BROWSERLESS
        sync: false

  - type: web
    runtime: node
    name: token-exchange
    plan: free
    buildCommand: npm ci && npm run build --filter=@documenso/token-exchange
    startCommand: cd apps/token-exchange && npm run start
    healthCheckPath: /api/health

    envVars:
      - key: NODE_VERSION
        value: "22"
      - key: TOKEN_EXCHANGE_SECRET
        sync: false
      - key: NEXT_PRIVATE_DATABASE_URL
        fromDatabase:
          name: documenso-db
          property: connectionString
      - key: NEXT_PRIVATE_DIRECT_DATABASE_URL
        fromDatabase:
          name: documenso-db
          property: connectionString
